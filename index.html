<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiseLife æœƒè­°åŠ©ç† v3.2</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* === WiseLife v3.2 è¦–è¦ºå‡ç´š (ä¿®æ­£å¤§æª”æ¡ˆå›æ‡‰ç­‰å¾…) === */
        :root { --primary: #00B900; --processing: #3498db; --warning: #f39c12; }
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background-color: #f4f6f9; color: #333; }
        .container { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; position: relative; }
        
        .version-tag { position: absolute; top: 15px; right: 15px; font-size: 0.75rem; color: #aaa; background: #eee; padding: 4px 8px; border-radius: 4px; }
        h2 { color: #2c3e50; text-align: center; margin-bottom: 25px; font-weight: 700; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }
        .sub-label { font-size: 0.8em; color: #888; font-weight: normal; margin-left: 5px; }

        input[type="text"], input[type="email"], input[type="file"] { 
            width: 100%; padding: 12px; border: 2px solid #eef2f7; border-radius: 10px; box-sizing: border-box; font-size: 16px; transition: all 0.3s;
        }
        input:focus { border-color: var(--primary); background: #fff; outline: none; }
        
        /* æª”æ¡ˆè³‡è¨Šæç¤º */
        .file-info { 
            margin-top: 10px; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 8px; 
            font-size: 0.85rem; 
            color: #666;
            display: none;
        }
        .file-info.large-file { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { 
            width: 100%; background: linear-gradient(135deg, #00B900 0%, #009900 100%); color: white; border: none; padding: 16px; 
            margin-top: 10px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,185,0,0.3); transition: transform 0.2s;
        }
        button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        button.close-btn { background: #7f8c8d; margin-top: 10px; display: none; }

        /* é€²åº¦æ¢å€åŸŸ */
        .progress-wrapper { margin-top: 25px; display: none; }
        .progress-container { width: 100%; background-color: #f1f1f1; border-radius: 10px; overflow: hidden; height: 12px; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--primary); border-radius: 10px; transition: width 0.3s ease; }
        
        /* å‘¼å¸ç‡ˆå‹•ç•« (Processing ç‹€æ…‹) */
        .progress-bar.processing {
            width: 100% !important;
            background-color: var(--processing);
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: progress-bar-stripes 1s linear infinite;
        }
        
        /* åˆä½µä¸­çš„æ©˜è‰²å‹•ç•« */
        .progress-bar.merging {
            width: 100% !important;
            background-color: var(--warning);
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: progress-bar-stripes 0.5s linear infinite;
        }
        
        @keyframes progress-bar-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

        .status-text { text-align: center; margin-top: 10px; font-size: 0.9rem; color: #666; font-weight: bold; }
        
        /* ç‹€æ…‹è¨Šæ¯ */
        .message-box { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; display: none; }
        .success { background: #e3fdf5; color: #00b894; border: 1px solid #ccfbf1; }
        .error { background: #ffebeb; color: #d63031; border: 1px solid #ffcccc; }

        /* Debug å€åŸŸ (å¯é¸æ“‡é¡¯ç¤º) */
        .debug-info {
            margin-top: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            font-size: 0.75rem;
            color: #666;
            display: none;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="version-tag">Ver 3.2 (ä¿®æ­£ç‰ˆ)</div>

        <h2>ğŸ™ï¸ WiseLife æœƒè­°åŠ©ç†</h2>
        <form id="uploadForm">
            <div class="form-group">
                <label>1. æª”æ¡ˆä¸Šå‚³ <span class="sub-label">(æ–‡ä»¶/éŒ„éŸ³)</span></label>
                <input type="file" id="fileInput" name="file" 
                       accept="audio/*,text/plain,.m4a,.mp3,.wav,.txt,.md,.pdf,.doc,.docx,.xls,.xlsx,.csv" required>
                <small style="color:#aaa; display:block; margin-top:5px;">ğŸ“‚ æ”¯æ´ PDF, Word, Excel, éŒ„éŸ³æª” (æ”¯æ´å¤§æª”æ¡ˆ)</small>
                <div id="fileInfo" class="file-info"></div>
            </div>
            
            <div class="form-group">
                <label>2. æ¥æ”¶ Email <span class="sub-label">(PDFå ±å‘Š)</span></label>
                <input type="email" id="emailInput" name="email" placeholder="è¼¸å…¥ Email ä»¥æ¥æ”¶å®Œæ•´ PDF å ±å‘Š">
            </div>

            <button type="submit" id="submitBtn">ğŸš€ é–‹å§‹æ™ºæ…§åˆ†æ</button>
            <button type="button" id="closeBtn" class="close-btn" onclick="liff.closeWindow()">âŒ é—œé–‰è¦–çª—</button>
        </form>

        <div class="progress-wrapper" id="progressWrapper">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="status-text" id="statusText">æº–å‚™ä¸­...</div>
        </div>

        <div id="resultMsg" class="message-box"></div>
        
        <!-- Debug è³‡è¨Š (é–‹ç™¼æ™‚å¯æ‰“é–‹) -->
        <div id="debugInfo" class="debug-info"></div>
    </div>

    <script>
        // ==========================================
        // âš™ï¸ è¨­å®šå€
        // ==========================================
        const LIFF_ID = "2008799993-Dq2SOrHq"; 
        const N8N_WEBHOOK_URL = "https://wiselifeai.zeabur.app/webhook/process-meeting";
        const CHUNK_SIZE = 20 * 1024 * 1024; // 20MB æ¯æ®µ
        const LARGE_FILE_THRESHOLD = 25 * 1024 * 1024; // 25MB
        const DEBUG_MODE = false; // è¨­ç‚º true å¯çœ‹åˆ°è©³ç´° log
        // ==========================================

        // Debug è¼”åŠ©å‡½æ•¸
        function debugLog(message) {
            console.log(`[WiseLife] ${message}`);
            if (DEBUG_MODE) {
                const debugDiv = document.getElementById('debugInfo');
                debugDiv.style.display = 'block';
                debugDiv.innerHTML += `${new Date().toLocaleTimeString()} - ${message}<br>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }

        // åˆå§‹åŒ– LIFF
        async function initLiff() {
            try {
                if(typeof liff !== 'undefined'){
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        const user = await liff.getDecodedIDToken();
                        if(user && user.email) {
                            document.getElementById('emailInput').value = user.email;
                        }
                    }
                }
            } catch (err) {
                console.error("LIFF Init Error:", err);
            }
        }
        initLiff();

        // æª”æ¡ˆé¸æ“‡æ™‚é¡¯ç¤ºè³‡è¨Š
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const fileInfo = document.getElementById('fileInfo');
            
            if (file) {
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                const isLarge = file.size > LARGE_FILE_THRESHOLD;
                
                fileInfo.textContent = `ğŸ“„ ${file.name} (${sizeMB} MB)`;
                fileInfo.style.display = 'block';
                
                if (isLarge) {
                    fileInfo.classList.add('large-file');
                    fileInfo.textContent += ' - å°‡ä½¿ç”¨åˆ†æ®µä¸Šå‚³æ¨¡å¼';
                } else {
                    fileInfo.classList.remove('large-file');
                }
            }
        });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const emailInput = document.getElementById('emailInput');
            
            if(fileInput.files.length === 0) { 
                alert("è«‹é¸æ“‡æª”æ¡ˆ"); 
                return; 
            }
            
            const file = fileInput.files[0];
            
            // æ±ºå®šä¸Šå‚³ç­–ç•¥
            if (file.size > LARGE_FILE_THRESHOLD) {
                await uploadLargeFile(file, emailInput.value);
            } else {
                await uploadSmallFile(file, emailInput.value);
            }
        });

        // ===== å°æª”æ¡ˆä¸Šå‚³ (åŸæœ‰é‚è¼¯) =====
        async function uploadSmallFile(file, email) {
            const submitBtn = document.getElementById('submitBtn');
            const closeBtn = document.getElementById('closeBtn');
            const progressWrapper = document.getElementById('progressWrapper');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            const resultMsg = document.getElementById('resultMsg');

            submitBtn.disabled = true;
            submitBtn.textContent = "â³ è™•ç†ä¸­...";
            resultMsg.style.display = "none";
            progressWrapper.style.display = "block";
            closeBtn.style.display = "none";

            const formData = new FormData();
            formData.append('file', file);
            formData.append('email', email);
            formData.append('uploadType', 'direct');

            try {
                if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    formData.append('userId', profile.userId);
                }
            } catch (e) {}

            const xhr = new XMLHttpRequest();
            xhr.open('POST', N8N_WEBHOOK_URL, true);
            xhr.timeout = 300000;

            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    progressBar.style.width = percent + "%";
                    progressBar.classList.remove("processing"); 
                    statusText.textContent = `ğŸ“¤ æª”æ¡ˆä¸Šå‚³ä¸­... ${percent}%`;

                    if (percent === 100) {
                        statusText.textContent = "ğŸ§  AI å¤§è…¦é‹è½‰ä¸­ (è«‹ç¨å€™ 30~60 ç§’)...";
                        progressBar.classList.add("processing");
                    }
                }
            };

            xhr.onload = async function() {
                if (xhr.status === 200) {
                    await handleSuccess(xhr.responseText, submitBtn, closeBtn, resultMsg, statusText);
                } else {
                    showError(`ä¼ºæœå™¨éŒ¯èª¤: ${xhr.status}`, submitBtn, closeBtn, resultMsg, progressBar, statusText);
                }
            };

            xhr.onerror = function() { 
                showError("ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚", submitBtn, closeBtn, resultMsg, progressBar, statusText); 
            };
            xhr.ontimeout = function() { 
                showError("è™•ç†é€¾æ™‚ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦éå¤§ã€‚", submitBtn, closeBtn, resultMsg, progressBar, statusText); 
            };

            xhr.send(formData);
        }

        // ===== å¤§æª”æ¡ˆåˆ†æ®µä¸Šå‚³ (ä¿®æ­£ç‰ˆ v3.2) =====
        async function uploadLargeFile(file, email) {
            const submitBtn = document.getElementById('submitBtn');
            const closeBtn = document.getElementById('closeBtn');
            const progressWrapper = document.getElementById('progressWrapper');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            const resultMsg = document.getElementById('resultMsg');

            submitBtn.disabled = true;
            submitBtn.textContent = "â³ åˆ†æ®µä¸Šå‚³ä¸­...";
            resultMsg.style.display = "none";
            progressWrapper.style.display = "block";
            closeBtn.style.display = "none";
            progressBar.classList.remove("processing", "merging");

            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            debugLog(`é–‹å§‹åˆ†æ®µä¸Šå‚³: ${file.name}, å…± ${totalChunks} æ®µ, SessionID: ${sessionId}`);
            statusText.textContent = `æº–å‚™åˆ†æ®µä¸Šå‚³ (å…± ${totalChunks} æ®µ)...`;

            try {
                let userId = '';
                if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                }

                let lastResponse = null;

                // ===== é€æ®µä¸Šå‚³ =====
                for (let i = 0; i < totalChunks; i++) {
                    const start = i * CHUNK_SIZE;
                    const end = Math.min(start + CHUNK_SIZE, file.size);
                    const chunk = file.slice(start, end);
                    const isLastChunk = (i === totalChunks - 1);

                    // æ›´æ–°é€²åº¦ (ä¸Šå‚³éšæ®µä½” 0-70%)
                    const uploadPercent = Math.round((i / totalChunks) * 70);
                    progressBar.style.width = uploadPercent + "%";
                    statusText.textContent = `ğŸ“¤ ä¸Šå‚³ç¬¬ ${i + 1}/${totalChunks} æ®µ (${uploadPercent}%)`;
                    debugLog(`ä¸Šå‚³åˆ†æ®µ ${i + 1}/${totalChunks}`);

                    // å°‡åˆ†æ®µè½‰ç‚º Base64
                    const base64Chunk = await blobToBase64(chunk);

                    // ç™¼é€é€™ä¸€æ®µ (å¸¶æœ‰é‡è©¦æ©Ÿåˆ¶)
                    const response = await fetchWithRetry(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: email,
                            userId: userId,
                            fileName: file.name,
                            sessionId: sessionId,
                            chunkIndex: i,
                            totalChunks: totalChunks,
                            chunkData: base64Chunk,
                            mimeType: file.type,
                            uploadType: 'chunked'
                        })
                    }, 3); // æœ€å¤šé‡è©¦ 3 æ¬¡

                    // è§£æ n8n å›æ‡‰
                    const responseData = await response.json();
                    debugLog(`åˆ†æ®µ ${i + 1} å›æ‡‰: ${JSON.stringify(responseData)}`);
                    
                    lastResponse = responseData;

                    // æª¢æŸ¥å›æ‡‰ç‹€æ…‹
                    if (responseData.status === 'error') {
                        throw new Error(responseData.message || 'ä¼ºæœå™¨è™•ç†å¤±æ•—');
                    }

                    // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€æ®µï¼ŒçŸ­æš«å»¶é²é¿å…éè¼‰
                    if (!isLastChunk) {
                        await sleep(300);
                    }
                }

                // ===== æ‰€æœ‰åˆ†æ®µä¸Šå‚³å®Œæˆ =====
                progressBar.style.width = "70%";
                progressBar.classList.add("merging");
                statusText.textContent = "ğŸ”„ ä¼ºæœå™¨åˆä½µåˆ†æ®µä¸­...";
                debugLog("æ‰€æœ‰åˆ†æ®µå·²ä¸Šå‚³ï¼Œç­‰å¾…ä¼ºæœå™¨è™•ç†...");

                // ===== ç­‰å¾… n8n å®Œæˆè™•ç† =====
                // æª¢æŸ¥æœ€å¾Œä¸€å€‹å›æ‡‰æ˜¯å¦å·²ç¶“åŒ…å«æœ€çµ‚çµæœ
                if (lastResponse && lastResponse.status === 'success' && lastResponse.summary) {
                    // n8n å·²ç¶“è™•ç†å®Œæˆï¼Œç›´æ¥é¡¯ç¤ºçµæœ
                    debugLog("n8n å·²å›å‚³æœ€çµ‚çµæœ");
                    progressBar.style.width = "100%";
                    progressBar.classList.remove("merging");
                    progressBar.classList.add("processing");
                    statusText.textContent = "âœ… è™•ç†å®Œæˆï¼";
                    
                    await handleSuccess(JSON.stringify(lastResponse), submitBtn, closeBtn, resultMsg, statusText);
                    
                } else if (lastResponse && lastResponse.readyForProcessing === true) {
                    // n8n æ­£åœ¨è™•ç†ä¸­ï¼Œéœ€è¦ç­‰å¾…
                    debugLog("n8n æ­£åœ¨è™•ç†ä¸­ï¼Œé–‹å§‹è¼ªè©¢...");
                    statusText.textContent = "ğŸ§  AI åˆ†æä¸­ (å¤§æª”æ¡ˆéœ€è¦è¼ƒé•·æ™‚é–“)...";
                    progressBar.classList.remove("merging");
                    progressBar.classList.add("processing");
                    
                    // ç­‰å¾…è™•ç†å®Œæˆ (æœ€é•·ç­‰å¾… 5 åˆ†é˜)
                    const finalResult = await waitForProcessingComplete(sessionId, 300000);
                    
                    if (finalResult) {
                        await handleSuccess(JSON.stringify(finalResult), submitBtn, closeBtn, resultMsg, statusText);
                    } else {
                        // å¦‚æœè¼ªè©¢å¤±æ•—ï¼Œä½†ä¸Šå‚³æˆåŠŸï¼Œé¡¯ç¤ºéƒ¨åˆ†æˆåŠŸè¨Šæ¯
                        resultMsg.innerHTML = `<strong>âœ… ä¸Šå‚³å®Œæˆï¼</strong><br>æª”æ¡ˆå·²é€å‡ºè™•ç†ï¼Œçµæœå°‡ç™¼é€è‡³æ‚¨çš„ Emailã€‚`;
                        resultMsg.className = "message-box success";
                        resultMsg.style.display = "block";
                        submitBtn.textContent = "ä¸Šå‚³å®Œæˆ";
                        closeBtn.style.display = "block";
                    }
                    
                } else {
                    // å‡è¨­è™•ç†ä¸­ï¼Œé¡¯ç¤ºä¸Šå‚³æˆåŠŸ
                    debugLog("ç„¡æ³•ç¢ºèªè™•ç†ç‹€æ…‹ï¼Œå‡è¨­è™•ç†ä¸­...");
                    progressBar.style.width = "100%";
                    progressBar.classList.remove("merging");
                    progressBar.classList.add("processing");
                    statusText.textContent = "ğŸ§  AI è™•ç†ä¸­ï¼Œçµæœå°‡ç™¼é€è‡³ Email...";
                    
                    // ç­‰å¾…ä¸€æ®µæ™‚é–“è®“ä½¿ç”¨è€…çŸ¥é“æ­£åœ¨è™•ç†
                    await sleep(3000);
                    
                    resultMsg.innerHTML = `<strong>âœ… ä¸Šå‚³å®Œæˆï¼</strong><br>å¤§æª”æ¡ˆè™•ç†éœ€è¦è¼ƒé•·æ™‚é–“ï¼Œå®Œæˆå¾Œå°‡ç™¼é€è‡³æ‚¨çš„ Emailã€‚`;
                    resultMsg.className = "message-box success";
                    resultMsg.style.display = "block";
                    submitBtn.textContent = "ä¸Šå‚³å®Œæˆ";
                    closeBtn.style.display = "block";
                }

            } catch (error) {
                debugLog(`éŒ¯èª¤: ${error.message}`);
                showError(`ä¸Šå‚³å¤±æ•—: ${error.message}`, submitBtn, closeBtn, resultMsg, progressBar, statusText);
            }
        }

        // ===== å¸¶é‡è©¦æ©Ÿåˆ¶çš„ fetch =====
        async function fetchWithRetry(url, options, maxRetries = 3) {
            let lastError;
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        // å¤§æª”æ¡ˆåˆ†æ®µéœ€è¦è¼ƒé•·çš„è¶…æ™‚æ™‚é–“
                        signal: AbortSignal.timeout(120000) // 2 åˆ†é˜è¶…æ™‚
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response;
                    
                } catch (error) {
                    lastError = error;
                    debugLog(`ç¬¬ ${attempt} æ¬¡å˜—è©¦å¤±æ•—: ${error.message}`);
                    
                    if (attempt < maxRetries) {
                        // æŒ‡æ•¸é€€é¿ï¼šç¬¬1æ¬¡ç­‰1ç§’ï¼Œç¬¬2æ¬¡ç­‰2ç§’ï¼Œç¬¬3æ¬¡ç­‰4ç§’
                        const waitTime = Math.pow(2, attempt - 1) * 1000;
                        debugLog(`ç­‰å¾… ${waitTime}ms å¾Œé‡è©¦...`);
                        await sleep(waitTime);
                    }
                }
            }
            
            throw lastError;
        }

        // ===== ç­‰å¾…è™•ç†å®Œæˆ (è¼ªè©¢æ©Ÿåˆ¶) =====
        async function waitForProcessingComplete(sessionId, maxWaitTime = 300000) {
            const startTime = Date.now();
            const pollInterval = 5000; // æ¯ 5 ç§’æª¢æŸ¥ä¸€æ¬¡
            
            debugLog(`é–‹å§‹è¼ªè©¢è™•ç†ç‹€æ…‹ï¼Œæœ€é•·ç­‰å¾… ${maxWaitTime / 1000} ç§’`);
            
            while (Date.now() - startTime < maxWaitTime) {
                try {
                    // å¯ä»¥å¯¦ä½œä¸€å€‹ç‹€æ…‹æŸ¥è©¢ç«¯é»ï¼Œé€™è£¡æš«æ™‚ä½¿ç”¨ç°¡å–®ç­‰å¾…
                    // å¦‚æœä½ çš„ n8n æœ‰ç‹€æ…‹æŸ¥è©¢ webhookï¼Œå¯ä»¥åœ¨é€™è£¡å‘¼å«
                    
                    await sleep(pollInterval);
                    
                    const elapsed = Math.round((Date.now() - startTime) / 1000);
                    const statusText = document.getElementById('statusText');
                    statusText.textContent = `ğŸ§  AI åˆ†æä¸­... (å·²ç­‰å¾… ${elapsed} ç§’)`;
                    
                    // é€™è£¡å¯ä»¥åŠ å…¥å¯¦éš›çš„ç‹€æ…‹æŸ¥è©¢é‚è¼¯
                    // const statusResponse = await fetch(`${N8N_WEBHOOK_URL}/status?sessionId=${sessionId}`);
                    // const status = await statusResponse.json();
                    // if (status.complete) return status.result;
                    
                } catch (error) {
                    debugLog(`è¼ªè©¢éŒ¯èª¤: ${error.message}`);
                }
            }
            
            debugLog("è¼ªè©¢è¶…æ™‚");
            return null;
        }

        // ===== è¼”åŠ©å‡½æ•¸ =====
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function handleSuccess(responseText, submitBtn, closeBtn, resultMsg, statusText) {
            try {
                const res = JSON.parse(responseText);
                const summaryText = res.summary || "æ‘˜è¦ç”Ÿæˆå®Œç•¢";
                
                debugLog(`è™•ç†æˆåŠŸ: ${summaryText.substring(0, 50)}...`);
                
                resultMsg.innerHTML = `<strong>âœ… åˆ†æå®Œæˆï¼</strong><br>æ‘˜è¦å·²å‚³é€è‡³ LINEï¼ŒPDF å·²å¯„å‡ºã€‚`;
                resultMsg.className = "message-box success";
                resultMsg.style.display = "block";
                
                submitBtn.textContent = "åˆ†æå®Œæˆ";
                closeBtn.style.display = "block";

                if (typeof liff !== 'undefined' && liff.isInClient && liff.isInClient()) {
                    statusText.textContent = "æ­£åœ¨å‚³é€ LINE è¨Šæ¯...";
                    await liff.sendMessages([{ type: 'text', text: `ğŸ“ æœƒè­°æ‘˜è¦ï¼š\n${summaryText}` }]);
                    
                    statusText.textContent = "3 ç§’å¾Œè‡ªå‹•é—œé–‰è¦–çª—...";
                    setTimeout(() => { liff.closeWindow(); }, 3000);
                }
            } catch (e) {
                debugLog(`è§£æå›æ‡‰éŒ¯èª¤: ${e.message}`);
                showError(`è§£æéŒ¯èª¤: ${e.message}`, submitBtn, closeBtn, resultMsg, null, statusText);
            }
        }

        function showError(msg, submitBtn, closeBtn, resultMsg, progressBar, statusText) {
            debugLog(`é¡¯ç¤ºéŒ¯èª¤: ${msg}`);
            resultMsg.innerHTML = `âŒ ${msg}`;
            resultMsg.className = "message-box error";
            resultMsg.style.display = "block";
            submitBtn.disabled = false;
            submitBtn.textContent = "é‡è©¦";
            if (progressBar) {
                progressBar.classList.remove("processing", "merging");
                progressBar.style.width = "0%";
            }
            statusText.textContent = "ç™¼ç”ŸéŒ¯èª¤";
            closeBtn.style.display = "block";
        }
    </script>
</body>
</html>
