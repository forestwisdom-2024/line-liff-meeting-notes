<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒè­°è¨˜éŒ„åŠ©æ‰‹</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        h2 { color: #333; text-align: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; background-color: #00B900; color: white; border: none; padding: 12px; margin-top: 10px; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
        button:hover { background-color: #009900; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { text-align: center; margin-top: 15px; color: #888; font-size: 0.9em; line-height: 1.5; }
        .error { color: #d9534f; }
        .success { color: #28a745; }
    </script>
    <style>
        /* ç°¡å–®çš„è¼‰å…¥å‹•ç•« */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #00B900; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; display: inline-block; vertical-align: middle; margin-right: 10px; display: none;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“ æœƒè­°èªéŸ³ä¸Šå‚³</h2>
        <form id="uploadForm">
            <div class="form-group">
                <label for="fileInput">1. é¸æ“‡æª”æ¡ˆ (éŒ„éŸ³/æ–‡å­—)</label>
                <input type="file" id="fileInput" name="file" accept="audio/*,text/plain,.m4a,.mp3,.txt" required>
            </div>
            
            <div class="form-group">
                <label for="emailInput">2. æ”¶ä»¶ Email (é¸å¡«)</label>
                <input type="email" id="emailInput" name="email" placeholder="è¼¸å…¥ Email ä»¥æ¥æ”¶ PDF æœƒè­°è¨˜éŒ„">
            </div>

            <button type="submit" id="submitBtn">
                <div class="loader" id="loader"></div>
                <span id="btnText">é–‹å§‹åˆ†æèˆ‡ç”Ÿæˆ</span>
            </button>
        </form>
        <div id="status"></div>
    </div>

    <script>
        // ==========================================
        // è¨­å®šå€ï¼šè«‹ä¿®æ”¹ä»¥ä¸‹å…©å€‹è®Šæ•¸
        // ==========================================
        const LIFF_ID = "2008799993-Dq2SOrHq"; // è«‹å¡«å…¥ä½ çš„ LIFF ID
        const N8N_WEBHOOK_URL = "https://richman.zeabur.app/webhook-test/process-meeting"; // ä½ çš„ n8n Webhook (POST) URL
        // ==========================================

        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            } catch (err) {
                document.getElementById('status').innerHTML = `<span class="error">LIFF åˆå§‹åŒ–å¤±æ•—: ${err.message}</span>`;
            }
        }
        main();

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('loader');
            const status = document.getElementById('status');
            const fileInput = document.getElementById('fileInput');
            const emailInput = document.getElementById('emailInput');

            if(fileInput.files.length === 0) {
                status.innerHTML = '<span class="error">è«‹å…ˆé¸æ“‡æª”æ¡ˆ</span>';
                return;
            }

            // UI é–å®šç‹€æ…‹
            btn.disabled = true;
            btnText.textContent = "ä¸Šå‚³è™•ç†ä¸­...";
            loader.style.display = "inline-block";
            status.textContent = "æª”æ¡ˆæ­£åœ¨ä¸Šå‚³è‡³ AI ä¼ºæœå™¨ï¼Œè«‹å‹¿é—œé–‰è¦–çª—...";

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('email', emailInput.value);

            try {
                // å˜—è©¦å–å¾—ä½¿ç”¨è€…è³‡æ–™
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    formData.append('userId', profile.userId);
                    formData.append('displayName', profile.displayName);
                }
            } catch (e) {
                console.warn('ç„¡æ³•å–å¾— LINE å€‹äººè³‡æ–™', e);
            }

            try {
                // ç™¼é€è‡³ n8n
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    body: formData
                    // æ³¨æ„ï¼šfetch å‚³é€ FormData æ™‚ä¸éœ€è¦æ‰‹å‹•è¨­å®š Content-Typeï¼Œç€è¦½å™¨æœƒè‡ªå‹•è™•ç†
                });

                if (response.ok) {
                    status.innerHTML = '<span class="success">âœ… ä¸Šå‚³æˆåŠŸï¼<br>AI æ­£åœ¨åˆ†æï¼Œçµæœå°‡é€é LINE é€šçŸ¥æ‚¨ã€‚</span>';
                    btnText.textContent = "å®Œæˆ";
                    loader.style.display = "none";
                    
                    // 3ç§’å¾Œè‡ªå‹•é—œé–‰è¦–çª—
                    setTimeout(() => {
                        liff.closeWindow();
                    }, 3000);
                    
                } else {
                    throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤: ${response.status}`);
                }
            } catch (error) {
                console.error(error);
                status.innerHTML = `<span class="error">âŒ ç™¼ç”ŸéŒ¯èª¤: ${error.message}<br>è«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚</span>`;
                btn.disabled = false;
                btnText.textContent = "å†è©¦ä¸€æ¬¡";
                loader.style.display = "none";
            }
        });
    </script>
</body>
</html>
