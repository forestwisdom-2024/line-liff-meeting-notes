<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiseLife æ™ºæ…§æœƒè­°åŠ©æ‰‹ v2.3</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* === WiseLife v2.3 æ¨£å¼ === */
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background-color: #f4f6f9; color: #333; }
        .container { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; position: relative; }
        
        /* ç‰ˆæœ¬æ¨™ç±¤ */
        .version-tag { position: absolute; top: 15px; right: 15px; font-size: 0.75rem; color: #aaa; background: #eee; padding: 4px 8px; border-radius: 4px; }

        h2 { color: #2c3e50; text-align: center; margin-bottom: 25px; font-weight: 700; letter-spacing: 1px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }
        .sub-label { font-size: 0.8em; color: #888; font-weight: normal; margin-left: 5px; }

        input[type="text"], input[type="email"], input[type="file"] { 
            width: 100%; padding: 12px; border: 2px solid #eef2f7; border-radius: 10px; box-sizing: border-box; font-size: 16px; transition: all 0.3s;
        }
        input:focus { border-color: #00B900; background: #fff; outline: none; }
        
        button { 
            width: 100%; background: linear-gradient(135deg, #00B900 0%, #009900 100%); color: white; border: none; padding: 16px; 
            margin-top: 20px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,185,0,0.3); transition: transform 0.2s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        
        #status { text-align: center; margin-top: 20px; font-size: 0.95em; line-height: 1.6; }
        .error { color: #d63031; background: #ffebeb; padding: 10px; border-radius: 8px; display: block; border: 1px solid #ffcccc; }
        .success { color: #00b894; background: #e3fdf5; padding: 10px; border-radius: 8px; display: block; border: 1px solid #ccfbf1; }

        .progress-container { width: 100%; background-color: #f1f1f1; border-radius: 10px; margin-top: 20px; display: none; overflow: hidden; height: 10px; }
        .progress-bar { width: 0%; height: 100%; background-color: #00B900; border-radius: 10px; transition: width 0.3s ease; }
        .progress-text { font-size: 0.8rem; text-align: center; margin-top: 8px; color: #999; display: none;}
    </style>
</head>
<body>
    <div class="container">
        <div class="version-tag">Ver 2.3.0 (Office Support)</div>

        <h2>ğŸ™ï¸ WiseLife æœƒè­°åŠ©ç†</h2>
        <form id="uploadForm">
            <div class="form-group">
                <label for="fileInput">æª”æ¡ˆä¸Šå‚³ <span class="sub-label">(èªéŸ³/æ–‡å­—/Office)</span></label>
                <input type="file" id="fileInput" name="file" 
                       accept="audio/*,text/plain,.m4a,.mp3,.wav,.txt,.md,.pdf,.doc,.docx,.xls,.xlsx,.csv" 
                       required>
                <small style="color:#888; display:block; margin-top:5px;">âš ï¸ é™åˆ¶ï¼šå–®æª” < 25MB</small>
            </div>
            
            <div class="form-group">
                <label for="emailInput">æ¥æ”¶ Email <span class="sub-label">(é¸å¡«)</span></label>
                <input type="email" id="emailInput" name="email" placeholder="è‹¥ç•™ç©ºå‰‡åƒ…é¡¯ç¤ºæ‘˜è¦">
            </div>

            <button type="submit" id="submitBtn">
                <span id="btnText">ğŸš€ é–‹å§‹æ™ºæ…§åˆ†æ</span>
            </button>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
        </form>
        <div id="status"></div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ è«‹å‹™å¿…ç¢ºèªé€™è£¡æœ‰æ›æˆæ‚¨è‡ªå·±çš„è³‡æ–™
        // ==========================================
        const LIFF_ID = "2008799993-Dq2SOrHq";  // <--- è¨˜å¾—æ›å›ä½ çš„ ID
        const N8N_WEBHOOK_URL = "https://wiselifeai.zeabur.app/webhook/process-meeting"; // <--- è¨˜å¾—æ›å›ä½ çš„ Webhook
        const MAX_FILE_SIZE_MB = 25; 
        // ==========================================

        async function initLiff() {
            try {
                if(typeof liff !== 'undefined'){
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        const user = await liff.getDecodedIDToken();
                        if(user && user.email) {
                            document.getElementById('emailInput').value = user.email;
                        }
                    }
                }
            } catch (err) {
                console.log("LIFF Init failed (maybe local testing):", err);
            }
        }
        initLiff();

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const status = document.getElementById('status');
            const fileInput = document.getElementById('fileInput');
            const emailInput = document.getElementById('emailInput');
            const pContainer = document.getElementById('progressContainer');
            const pBar = document.getElementById('progressBar');
            const pText = document.getElementById('progressText');

            if(fileInput.files.length === 0) { alert("è«‹é¸æ“‡æª”æ¡ˆ"); return; }
            
            const file = fileInput.files[0];
            const fileSizeMB = file.size / (1024 * 1024);
            if (fileSizeMB > MAX_FILE_SIZE_MB) {
                status.innerHTML = `<span class="error">âŒ æª”æ¡ˆéå¤§ (${fileSizeMB.toFixed(2)}MB)<br>è«‹å°‡æª”æ¡ˆåˆ‡å‰²æˆ–å£“ç¸®è‡³ ${MAX_FILE_SIZE_MB}MB ä»¥ä¸‹ã€‚</span>`;
                return;
            }

            btn.disabled = true;
            status.innerHTML = "";
            pContainer.style.display = "block";
            pText.style.display = "block";
            pBar.style.width = "0%";
            pText.textContent = "ä¸Šå‚³ä¸­...";

            const formData = new FormData();
            formData.append('file', file);
            formData.append('email', emailInput.value);

            try {
                if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    formData.append('userId', profile.userId);
                }
            } catch (e) {}

            const xhr = new XMLHttpRequest();
            xhr.open('POST', N8N_WEBHOOK_URL, true);
            xhr.timeout = 300000; 

            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    pBar.style.width = percent + "%";
                    pText.textContent = `${percent}%`;
                    if (percent === 100) {
                        btnText.textContent = "ğŸ§  AI å¤§è…¦é‹è½‰ä¸­...";
                        pText.textContent = "ä¸Šå‚³å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆæ‘˜è¦ (è«‹å‹¿é—œé–‰)...";
                    }
                }
            };

            xhr.onload = async function() {
                if (xhr.status === 200) {
                    try {
                        const res = JSON.parse(xhr.responseText);
                        status.innerHTML = `<span class="success">âœ… åˆ†æå®Œæˆï¼</span>`;
                        btnText.textContent = "å®Œæˆ";
                        
                        const summaryText = res.summary || "æ‘˜è¦ç”Ÿæˆå®Œç•¢";
                        const emailNote = emailInput.value ? "\n(å®Œæ•´ HTML å ±å‘Šå·²å¯„å‡º)" : "\n(æœªå¡«å¯« Email)";

                        if (typeof liff !== 'undefined' && liff.isInClient && liff.isInClient()) {
                            await liff.sendMessages([{ 
                                type: 'text', 
                                text: `ğŸ“ WiseLife æœƒè­°æ‘˜è¦ï¼š\n\n${summaryText}\n${emailNote}` 
                            }]);
                            liff.closeWindow();
                        } else {
                            alert("ğŸ“ æ‘˜è¦çµæœï¼š\n\n" + summaryText);
                        }
                    } catch (e) {
                        status.innerHTML = `<span class="error">JSON éŒ¯èª¤: ${e.message}</span>`;
                        console.log("Raw Response:", xhr.responseText);
                    }
                } else {
                    status.innerHTML = `<span class="error">Server Error: ${xhr.status}</span>`;
                    btn.disabled = false;
                    btnText.textContent = "é‡è©¦";
                }
            };

            xhr.onerror = function() {
                status.innerHTML = `<span class="error">âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤ (è«‹æª¢æŸ¥ Webhook CORS)</span>`;
                btn.disabled = false;
                btnText.textContent = "é‡è©¦";
            };

            xhr.send(formData);
        });
    </script>
</body>
</html>
