<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiseLife æœƒè­°åŠ©ç† v3.0</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* === WiseLife v3.0 è¦–è¦ºå‡ç´š === */
        :root { --primary: #00B900; --processing: #3498db; }
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background-color: #f4f6f9; color: #333; }
        .container { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; position: relative; }
        
        .version-tag { position: absolute; top: 15px; right: 15px; font-size: 0.75rem; color: #aaa; background: #eee; padding: 4px 8px; border-radius: 4px; }
        h2 { color: #2c3e50; text-align: center; margin-bottom: 25px; font-weight: 700; }

        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #555; font-weight: bold; }
        .sub-label { font-size: 0.8em; color: #888; font-weight: normal; margin-left: 5px; }

        input[type="text"], input[type="email"], input[type="file"] { 
            width: 100%; padding: 12px; border: 2px solid #eef2f7; border-radius: 10px; box-sizing: border-box; font-size: 16px; transition: all 0.3s;
        }
        input:focus { border-color: var(--primary); background: #fff; outline: none; }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button { 
            width: 100%; background: linear-gradient(135deg, #00B900 0%, #009900 100%); color: white; border: none; padding: 16px; 
            margin-top: 10px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,185,0,0.3); transition: transform 0.2s;
        }
        button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        button.close-btn { background: #7f8c8d; margin-top: 10px; display: none; } /* é è¨­éš±è— */

        /* é€²åº¦æ¢å€åŸŸ */
        .progress-wrapper { margin-top: 25px; display: none; }
        .progress-container { width: 100%; background-color: #f1f1f1; border-radius: 10px; overflow: hidden; height: 12px; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--primary); border-radius: 10px; transition: width 0.3s ease; }
        
        /* å‘¼å¸ç‡ˆå‹•ç•« (Processing ç‹€æ…‹) */
        .progress-bar.processing {
            width: 100% !important;
            background-color: var(--processing);
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
            animation: progress-bar-stripes 1s linear infinite;
        }
        @keyframes progress-bar-stripes { from { background-position: 1rem 0; } to { background-position: 0 0; } }

        .status-text { text-align: center; margin-top: 10px; font-size: 0.9rem; color: #666; font-weight: bold; }
        
        /* ç‹€æ…‹è¨Šæ¯ */
        .message-box { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; display: none; }
        .success { background: #e3fdf5; color: #00b894; border: 1px solid #ccfbf1; }
        .error { background: #ffebeb; color: #d63031; border: 1px solid #ffcccc; }

    </style>
</head>
<body>
    <div class="container">
        <div class="version-tag">Ver 3.0 (PDF+UX)</div>

        <h2>ğŸ™ï¸ WiseLife æœƒè­°åŠ©ç†</h2>
        <form id="uploadForm">
            <div class="form-group">
                <label>1. æª”æ¡ˆä¸Šå‚³ <span class="sub-label">(æ–‡ä»¶/éŒ„éŸ³)</span></label>
                <input type="file" id="fileInput" name="file" 
                       accept="audio/*,text/plain,.m4a,.mp3,.wav,.txt,.md,.pdf,.doc,.docx,.xls,.xlsx,.csv" required>
                <small style="color:#aaa; display:block; margin-top:5px;">ğŸ“‚ æ”¯æ´ PDF, Word, Excel, éŒ„éŸ³æª” (Max 25MB)</small>
            </div>
            
            <div class="form-group">
                <label>2. æ¥æ”¶ Email <span class="sub-label">(PDFå ±å‘Š)</span></label>
                <input type="email" id="emailInput" name="email" placeholder="è¼¸å…¥ Email ä»¥æ¥æ”¶å®Œæ•´ PDF å ±å‘Š">
            </div>

            <button type="submit" id="submitBtn">ğŸš€ é–‹å§‹æ™ºæ…§åˆ†æ</button>
            <button type="button" id="closeBtn" class="close-btn" onclick="liff.closeWindow()">âŒ é—œé–‰è¦–çª—</button>
        </form>

        <div class="progress-wrapper" id="progressWrapper">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="status-text" id="statusText">æº–å‚™ä¸­...</div>
        </div>

        <div id="resultMsg" class="message-box"></div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ è‡ªå‹•å¸¶å…¥æ‚¨çš„è¨­å®š (è«‹ç¢ºèªæ˜¯å¦æ­£ç¢º)
        // ==========================================
        const LIFF_ID = "2008799993-Dq2SOrHq"; 
        const N8N_WEBHOOK_URL = "https://wiselifeai.zeabur.app/webhook/process-meeting";
        const MAX_FILE_SIZE_MB = 25; 
        // ==========================================

        // åˆå§‹åŒ– LIFF
        async function initLiff() {
            try {
                if(typeof liff !== 'undefined'){
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    } else {
                        // è‡ªå‹•æŠ“å– Email
                        const user = await liff.getDecodedIDToken();
                        if(user && user.email) {
                            document.getElementById('emailInput').value = user.email;
                        }
                    }
                }
            } catch (err) {
                console.error("LIFF Init Error:", err);
            }
        }
        initLiff();

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('fileInput');
            const emailInput = document.getElementById('emailInput');
            const submitBtn = document.getElementById('submitBtn');
            const closeBtn = document.getElementById('closeBtn');
            
            const progressWrapper = document.getElementById('progressWrapper');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            const resultMsg = document.getElementById('resultMsg');

            // 1. æª¢æŸ¥æª”æ¡ˆ
            if(fileInput.files.length === 0) { alert("è«‹é¸æ“‡æª”æ¡ˆ"); return; }
            const file = fileInput.files[0];
            if (file.size / 1024 / 1024 > MAX_FILE_SIZE_MB) {
                alert(`æª”æ¡ˆéå¤§ï¼è«‹é™åˆ¶åœ¨ ${MAX_FILE_SIZE_MB}MB ä»¥å…§`);
                return;
            }

            // 2. UI ç‹€æ…‹é–å®š
            submitBtn.disabled = true;
            submitBtn.textContent = "â³ è™•ç†ä¸­...";
            resultMsg.style.display = "none";
            progressWrapper.style.display = "block";
            closeBtn.style.display = "none"; // è™•ç†ä¸­ä¸çµ¦é—œé–‰ï¼Œé¿å…ä¸­æ–·

            const formData = new FormData();
            formData.append('file', file);
            formData.append('email', emailInput.value);

            // å˜—è©¦åŠ å…¥ UserId
            try {
                if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    formData.append('userId', profile.userId);
                }
            } catch (e) {}

            const xhr = new XMLHttpRequest();
            xhr.open('POST', N8N_WEBHOOK_URL, true);
            xhr.timeout = 300000; // 5åˆ†é˜è¶…æ™‚

            // 3. ä¸Šå‚³é€²åº¦ç›£è½ (Phase 1)
            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    // ä¸Šå‚³éšæ®µï¼šç¶ è‰²é€²åº¦æ¢
                    progressBar.style.width = percent + "%";
                    progressBar.classList.remove("processing"); 
                    statusText.textContent = `ğŸ“¤ æª”æ¡ˆä¸Šå‚³ä¸­... ${percent}%`;

                    if (percent === 100) {
                        // ä¸Šå‚³å®Œæˆï¼Œé€²å…¥ Phase 2 (AI è™•ç†)
                        statusText.textContent = "ğŸ§  AI å¤§è…¦é‹è½‰ä¸­ (è«‹ç¨å€™ 30~60 ç§’)...";
                        progressBar.classList.add("processing"); // è®Šè‰²+å‹•ç•«
                    }
                }
            };

            // 4. å®Œæˆè™•ç†
            xhr.onload = async function() {
                if (xhr.status === 200) {
                    try {
                        const res = JSON.parse(xhr.responseText);
                        const summaryText = res.summary || "æ‘˜è¦ç”Ÿæˆå®Œç•¢";
                        
                        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                        resultMsg.innerHTML = `<strong>âœ… åˆ†æå®Œæˆï¼</strong><br>æ‘˜è¦å·²å‚³é€è‡³ LINEï¼ŒPDF å·²å¯„å‡ºã€‚`;
                        resultMsg.className = "message-box success";
                        resultMsg.style.display = "block";
                        
                        // è®Šæ›´æŒ‰éˆ•ç‹€æ…‹
                        submitBtn.textContent = "åˆ†æå®Œæˆ";
                        closeBtn.style.display = "block"; // é¡¯ç¤ºæ‰‹å‹•é—œé–‰æŒ‰éˆ•

                        // å˜—è©¦ç™¼é€ LINE è¨Šæ¯ä¸¦è‡ªå‹•é—œé–‰
                        if (typeof liff !== 'undefined' && liff.isInClient && liff.isInClient()) {
                            statusText.textContent = "æ­£åœ¨å‚³é€ LINE è¨Šæ¯...";
                            await liff.sendMessages([{ type: 'text', text: `ğŸ“ æœƒè­°æ‘˜è¦ï¼š\n${summaryText}` }]);
                            
                            // å€’æ•¸å¾Œé—œé–‰
                            statusText.textContent = "3 ç§’å¾Œè‡ªå‹•é—œé–‰è¦–çª—...";
                            setTimeout(() => { liff.closeWindow(); }, 3000);
                        }
                    } catch (e) {
                        showError(`è§£æéŒ¯èª¤: ${e.message}`);
                    }
                } else {
                    showError(`ä¼ºæœå™¨éŒ¯èª¤: ${xhr.status}`);
                }
            };

            xhr.onerror = function() { showError("ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚"); };
            xhr.ontimeout = function() { showError("è™•ç†é€¾æ™‚ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦éå¤§ã€‚"); };

            function showError(msg) {
                resultMsg.innerHTML = `âŒ ${msg}`;
                resultMsg.className = "message-box error";
                resultMsg.style.display = "block";
                submitBtn.disabled = false;
                submitBtn.textContent = "é‡è©¦";
                progressBar.classList.remove("processing");
                progressBar.style.width = "0%";
                statusText.textContent = "ç™¼ç”ŸéŒ¯èª¤";
                closeBtn.style.display = "block"; // å‡ºéŒ¯æ™‚ä¹Ÿçµ¦é—œé–‰æŒ‰éˆ•
            }

            xhr.send(formData);
        });
    </script>
</body>
</html>
